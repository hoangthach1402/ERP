<%- include('header') %>

<div class="mb-6">
  <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Sản Xuất</h1>
  
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm">Tổng Sản Phẩm</p>
          <p class="text-3xl font-bold text-gray-800"><%= stats.total %></p>
        </div>
        <i class="fas fa-box text-4xl text-blue-300"></i>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm">Đang Xử Lý</p>
          <p class="text-3xl font-bold text-gray-800"><%= stats.processing %></p>
        </div>
        <i class="fas fa-cogs text-4xl text-yellow-300"></i>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm">Hoàn Thành</p>
          <p class="text-3xl font-bold text-gray-800"><%= stats.completed %></p>
        </div>
        <i class="fas fa-check-circle text-4xl text-green-300"></i>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-500 text-sm">Trễ Hạn</p>
          <p class="text-3xl font-bold text-red-600"><%= stats.delayed %></p>
        </div>
        <i class="fas fa-exclamation-circle text-4xl text-red-300"></i>
      </div>
    </div>
  </div>

  <!-- Create Product Section -->
  <% if (user.role === 'ADMIN') { %>
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">Tạo Sản Phẩm Mới</h2>
      <form id="createProductForm" method="POST" action="/product/create">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <input type="text" id="product_code" name="product_code" placeholder="Mã Sản Phẩm" required
            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
          <input type="text" id="product_name" name="product_name" placeholder="Tên Sản Phẩm" required
            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-3">Định Mức Mỗi Khâu (giờ)</label>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
            <div>
              <label class="text-xs text-gray-600">1. Rập</label>
              <input type="number" name="stage_1_hours" placeholder="Giờ" min="0" max="999" value="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
            </div>
            <div>
              <label class="text-xs text-gray-600">2. Cắt</label>
              <input type="number" name="stage_2_hours" placeholder="Giờ" min="0" max="999" value="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
            </div>
            <div>
              <label class="text-xs text-gray-600">3. May</label>
              <input type="number" name="stage_3_hours" placeholder="Giờ" min="0" max="999" value="6"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
            </div>
            <div>
              <label class="text-xs text-gray-600">4. Thiết Kế</label>
              <input type="number" name="stage_4_hours" placeholder="Giờ" min="0" max="999" value="6"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
            </div>
            <div>
              <label class="text-xs text-gray-600">5. Đính Kết</label>
              <input type="number" name="stage_5_hours" placeholder="Giờ" min="0" max="999" value="12"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
            </div>
          </div>
        </div>
        
        <button type="submit" class="w-full md:w-auto bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
          <i class="fas fa-plus mr-2"></i>Tạo Mới
        </button>
      </form>
    </div>
  <% } %>

  <!-- Products Table -->
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-bold text-gray-800">Danh Sách Sản Phẩm</h2>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-100 border-b border-gray-200">
          <tr>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Mã SP</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Tên SP</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Khâu Hiện Tại</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Tiến Độ</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Trạng Thái</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Thời Gian Trôi (h)</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Hành Động</th>
          </tr>
        </thead>
        <tbody>
          <% if (products && products.length > 0) { %>
            <% products.forEach(product => { %>
              <tr class="border-b border-gray-200 hover:bg-gray-50 transition">
                <td class="px-6 py-4 text-sm font-semibold text-gray-800"><%= product.product_code %></td>
                <td class="px-6 py-4 text-sm text-gray-700"><%= product.product_name %></td>
                <td class="px-6 py-4 text-sm text-gray-700"><%= product.stage_name || '-' %></td>
                <td class="px-6 py-4">
                  <div class="flex items-center">
                    <% 
                      let progress = 0;
                      if (product.status === 'completed') progress = 100;
                      else if (product.current_stage_id === 1) progress = 20;
                      else if (product.current_stage_id === 2) progress = 40;
                      else if (product.current_stage_id === 3) progress = 60;
                      else if (product.current_stage_id === 4) progress = 80;
                      else if (product.current_stage_id === 5) progress = 100;
                    %>
                    <div class="flex-1 bg-gray-200 rounded-full h-2 mr-3" style="width: 100px;">
                      <div class="bg-purple-600 h-2 rounded-full" style="width: <%= progress %>%;"></div>
                    </div>
                    <span class="text-xs text-gray-600"><%= progress %>%</span>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <% 
                    let statusClass = 'status-pending';
                    if (product.status === 'processing') statusClass = 'status-processing';
                    else if (product.status === 'completed') statusClass = 'status-completed';
                    else if (product.is_delayed === 1) statusClass = 'status-delayed';
                  %>
                  <span class="<%= statusClass %> text-xs font-semibold px-3 py-1 rounded-full">
                    <% if (product.is_delayed === 1) { %>
                      <i class="fas fa-exclamation mr-1"></i>TRỄ HẠN
                    <% } else if (product.status === 'completed') { %>
                      <i class="fas fa-check mr-1"></i>HOÀN THÀNH
                    <% } else if (product.status === 'processing') { %>
                      <i class="fas fa-spinner mr-1"></i>ĐANG LÀM
                    <% } else { %>
                      <i class="fas fa-pause mr-1"></i>CHỜ ĐỢI
                    <% } %>
                  </span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-700">
                  <% if (product.elapsed_hours) { %>
                    <span class="<%= product.elapsed_hours > product.norm_hours ? 'text-red-600 font-bold' : 'text-gray-600' %>">
                      <%= product.elapsed_hours %> / <%= product.norm_hours %>
                    </span>
                  <% } else { %>
                    <span class="text-gray-400">-</span>
                  <% } %>
                </td>
                <td class="px-6 py-4 text-sm">
                  <a href="/product/<%= product.id %>" class="text-purple-600 hover:text-purple-800 mr-3">
                    <i class="fas fa-eye"></i>
                  </a>
                  <% if (product.status !== 'completed') { %>
                    <a href="/scan/page?productId=<%= product.id %>" class="text-blue-600 hover:text-blue-800">
                      <i class="fas fa-qrcode"></i>
                    </a>
                  <% } %>
                </td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-4"></i>
                <p>Không có sản phẩm nào</p>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Recent Activities -->
  <div class="bg-white rounded-lg shadow mt-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-bold text-gray-800">Hoạt Động Gần Đây</h2>
    </div>
    <div class="divide-y">
      <% if (recentLogs && recentLogs.length > 0) { %>
        <% recentLogs.forEach(log => { %>
          <div class="px-6 py-4 text-sm">
            <div class="flex justify-between">
              <span class="font-semibold text-gray-800"><%= log.full_name %></span>
              <span class="text-gray-500"><%= new Date(log.created_at).toLocaleString('vi-VN') %></span>
            </div>
            <p class="text-gray-600"><i class="fas fa-circle text-xs mr-2"></i><%= log.action %></p>
            <% if (log.product_code) { %>
              <p class="text-gray-500 text-xs">Sản phẩm: <strong><%= log.product_code %></strong></p>
            <% } %>
          </div>
        <% }); %>
      <% } else { %>
        <div class="px-6 py-8 text-center text-gray-500">
          <p>Không có hoạt động nào</p>
        </div>
      <% } %>
    </div>
  </div>
</div>

<script>
document.getElementById('createProductForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const product_code = document.getElementById('product_code').value.trim();
  const product_name = document.getElementById('product_name').value.trim();

  // Client-side validation
  if (!product_code || !product_name) {
    alert('✗ Vui lòng điền tất cả trường');
    return;
  }

  if (product_code.length < 2 || product_code.length > 50) {
    alert('✗ Mã sản phẩm phải từ 2-50 ký tự');
    return;
  }

  if (product_name.length < 2 || product_name.length > 100) {
    alert('✗ Tên sản phẩm phải từ 2-100 ký tự');
    return;
  }

  // Show loading state
  const submitButton = document.querySelector('#createProductForm button[type="submit"]');
  const originalText = submitButton.innerHTML;
  submitButton.disabled = true;
  submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang tạo...';

  const formData = {
    product_code,
    product_name
  };

  try {
    const response = await fetch('/product/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });

    const data = await response.json();

    if (response.ok) {
      alert('✓ Sản phẩm đã được tạo thành công!');
      document.getElementById('createProductForm').reset();
      setTimeout(() => location.reload(), 1500);
    } else {
      alert('✗ ' + (data.error || 'Lỗi tạo sản phẩm'));
      submitButton.disabled = false;
      submitButton.innerHTML = originalText;
    }
  } catch (error) {
    console.error('Error:', error);
    alert('✗ Lỗi server. Vui lòng thử lại sau');
    submitButton.disabled = false;
    submitButton.innerHTML = originalText;
  }
});
</script>

<%- include('footer') %>
