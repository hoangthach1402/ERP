<%- include('../header', { title: 'Dashboard Thu Mua' }) %>

<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6">Dashboard Thu Mua - Qu·∫£n L√Ω Nguy√™n V·∫≠t Li·ªáu</h1>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-yellow-100 p-6 rounded-lg shadow">
      <div class="text-yellow-800 text-sm font-semibold">Ch·ªù X·ª≠ L√Ω</div>
      <div class="text-3xl font-bold"><%= stats.pending %></div>
    </div>
    <div class="bg-blue-100 p-6 rounded-lg shadow">
      <div class="text-blue-800 text-sm font-semibold">ƒê√£ Mua</div>
      <div class="text-3xl font-bold"><%= stats.purchased %></div>
    </div>
    <div class="bg-green-100 p-6 rounded-lg shadow">
      <div class="text-green-800 text-sm font-semibold">ƒê√£ Giao</div>
      <div class="text-3xl font-bold"><%= stats.delivered %></div>
    </div>
    <div class="bg-gray-100 p-6 rounded-lg shadow">
      <div class="text-gray-800 text-sm font-semibold">T·ªïng</div>
      <div class="text-3xl font-bold"><%= stats.total %></div>
    </div>
  </div>

  <!-- Pending Requests -->
  <div class="bg-white rounded-lg shadow mb-8">
    <div class="px-6 py-4 border-b">
      <h2 class="text-xl font-semibold text-red-600">‚ö†Ô∏è Y√™u C·∫ßu ƒêang Ch·ªù X·ª≠ L√Ω</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">M√£ SP</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">T√™n SP</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">B·ªô Ph·∫≠n</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">L√Ω Do</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ng∆∞·ªùi Y√™u C·∫ßu</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Th·ªùi Gian</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">H√†nh ƒê·ªông</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% if (pendingRequests.length === 0) { %>
            <tr>
              <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                Kh√¥ng c√≥ y√™u c·∫ßu n√†o ƒëang ch·ªù x·ª≠ l√Ω
              </td>
            </tr>
          <% } else { %>
            <% pendingRequests.forEach(request => { %>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap font-mono text-sm">
                  <a href="/purchasing/request/<%= request.id %>" class="text-blue-600 hover:text-blue-800 hover:underline">
                    <%= request.product_code %>
                  </a>
                </td>
                <td class="px-6 py-4">
                  <a href="/purchasing/request/<%= request.id %>" class="text-blue-600 hover:text-blue-800 hover:underline">
                    <%= request.product_name %>
                  </a>
                </td>
                <td class="px-6 py-4">
                  <span class="px-2 py-1 text-xs rounded-full <%= request.stage_name === 'R·∫¨P' ? 'bg-blue-100 text-blue-800' : request.stage_name === 'C·∫ÆT' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800' %>">
                    <%= request.stage_name %>
                  </span>
                </td>
                <td class="px-6 py-4 text-sm"><%= request.reason %></td>
                <td class="px-6 py-4 text-sm"><%= request.requested_by_name %></td>
                <td class="px-6 py-4 text-sm text-gray-500"><%= new Date(request.created_at).toLocaleString('vi-VN') %></td>
                <td class="px-6 py-4">
                  <button onclick="confirmPurchase(<%= request.id %>)" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm">
                    X√°c Nh·∫≠n Mua
                  </button>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- All Requests History -->
  <div class="bg-white rounded-lg shadow">
    <div class="px-6 py-4 border-b">
      <h2 class="text-xl font-semibold">üìã L·ªãch S·ª≠ Y√™u C·∫ßu</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">M√£ SP</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">B·ªô Ph·∫≠n</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">L√Ω Do</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tr·∫°ng Th√°i</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ng∆∞·ªùi Mua</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ng√†y D·ª± Ki·∫øn</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% if (allRequests.length === 0) { %>
            <tr>
              <td colspan="6" class="px-6 py-4 text-center text-gray-500">Ch∆∞a c√≥ y√™u c·∫ßu n√†o</td>
            </tr>
          <% } else { %>
            <% allRequests.slice(0, 20).forEach(request => { %>
              <tr class="hover:bg-gray-50 cursor-pointer" onclick="window.location='/purchasing/request/<%= request.id %>'">
                <td class="px-6 py-4 whitespace-nowrap font-mono text-sm text-blue-600 hover:text-blue-800 hover:underline">
                  <%= request.product_code %>
                </td>
                <td class="px-6 py-4 text-sm"><%= request.stage_name %></td>
                <td class="px-6 py-4 text-sm"><%= request.reason %></td>
                <td class="px-6 py-4">
                  <span class="px-2 py-1 text-xs rounded-full <%= request.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : request.status === 'purchased' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800' %>">
                    <%= request.status === 'pending' ? 'Ch·ªù' : request.status === 'purchased' ? 'ƒê√£ Mua' : 'ƒê√£ Giao' %>
                  </span>
                </td>
                <td class="px-6 py-4 text-sm"><%= request.purchased_by_name || '-' %></td>
                <td class="px-6 py-4 text-sm">
                  <% if (request.expected_delivery_date) { %>
                    <span class="px-3 py-1 rounded text-xs font-semibold bg-indigo-100 text-indigo-700">
                      <%= new Date(request.expected_delivery_date).toLocaleDateString('vi-VN') %>
                    </span>
                  <% } else { %>
                    <span class="text-gray-400">-</span>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal x√°c nh·∫≠n mua -->
<div id="purchaseModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <h3 class="text-lg font-semibold mb-4">X√°c Nh·∫≠n ƒê√£ Mua Nguy√™n V·∫≠t Li·ªáu</h3>
    <form id="purchaseForm">
      <input type="hidden" id="requestId" name="requestId">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Ng√†y D·ª± Ki·∫øn Giao H√†ng *</label>
        <input type="date" id="expectedDeliveryDate" name="expected_delivery_date" required
               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Ghi Ch√∫</label>
        <textarea id="responseNote" name="response_note" rows="3"
                  class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Th√¥ng tin b·ªï sung..."></textarea>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">
          H·ªßy
        </button>
        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
          X√°c Nh·∫≠n
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function confirmPurchase(requestId) {
  document.getElementById('requestId').value = requestId;
  document.getElementById('purchaseModal').classList.remove('hidden');
  
  // Set minimum date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('expectedDeliveryDate').setAttribute('min', today);
}

function closeModal() {
  document.getElementById('purchaseModal').classList.add('hidden');
  document.getElementById('purchaseForm').reset();
}

document.getElementById('purchaseForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);
  
  try {
    const response = await fetch('/purchasing/confirm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('ƒê√£ x√°c nh·∫≠n mua nguy√™n v·∫≠t li·ªáu th√†nh c√¥ng!');
      location.reload();
    } else {
      alert(result.error || 'C√≥ l·ªói x·∫£y ra');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('L·ªói k·∫øt n·ªëi');
  }
});
</script>

<%- include('../footer') %>
