<%- include('../header') %>

<style>
  .badge-pending {
    background-color: #FEF3C7;
    color: #92400E;
  }
  
  .badge-purchased {
    background-color: #D1FAE5;
    color: #065F46;
  }
  
  .badge-delivered {
    background-color: #E0F2FE;
    color: #0C4A6E;
  }

  .message-item {
    border-left: 4px solid #3B82F6;
    padding-left: 1rem;
    margin-bottom: 1rem;
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
  }

  .message-item.from-purchaser {
    border-left-color: #10B981;
  }

  .message-item.from-department {
    border-left-color: #F59E0B;
  }

  .comment-form textarea {
    resize: vertical;
    min-height: 100px;
  }

  .status-badge {
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-block;
    margin: 0.25rem;
  }

  .deadline-badge {
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-block;
    margin: 0.25rem;
  }

  .deadline-badge.urgent {
    background-color: #FEE2E2;
    color: #991B1B;
  }

  .deadline-badge.warning {
    background-color: #FEF3C7;
    color: #92400E;
  }

  .deadline-badge.normal {
    background-color: #DBEAFE;
    color: #1E40AF;
  }
</style>

<script>
  console.log('Page role:', '<%= role %>');
</script>

<div class="container mx-auto px-4 py-8">
  <!-- Breadcrumb / Back Navigation -->
  <div class="mb-6 flex items-center gap-2 text-gray-600 text-sm">
    <% if (role === 'THU_MUA' || role === 'ADMIN') { %>
      <a href="/purchasing/dashboard" class="text-blue-600 hover:underline">Quản lý mua hàng</a>
      <span>/</span>
    <% } else { %>
      <button onclick="window.location.href='/scan/page'; return false;" class="text-blue-600 hover:text-blue-800 font-semibold bg-none border-none cursor-pointer p-0" type="button">
        ← Quay lại
      </button>
      <span>/</span>
    <% } %>
    <span>Chi tiết yêu cầu #<%= request.id %></span>
  </div>

  <!-- Request Header -->
  <div class="bg-white rounded-lg shadow mb-6 p-6">
    <div class="flex justify-between items-start mb-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
          Yêu cầu #<%= request.id %>
        </h1>
        <p class="text-gray-600">
          Sản phẩm: <strong><%= request.product_code %></strong> - <%= request.product_name %>
        </p>
      </div>
      <div class="text-right">
        <% 
          const statusTexts = { pending: 'Chờ mua', purchased: 'Đã mua', delivered: 'Đã giao' };
          const statusClasses = { pending: 'badge-pending', purchased: 'badge-purchased', delivered: 'badge-delivered' };
        %>
        <span class="status-badge <%= statusClasses[request.status] %>">
          <%= statusTexts[request.status] || request.status %>
        </span>
        <% if (request.expected_delivery_date) {
          const today = new Date();
          const delivery = new Date(request.expected_delivery_date);
          const daysLeft = Math.ceil((delivery - today) / (1000 * 60 * 60 * 24));
          const deadlineClass = daysLeft < 0 ? 'urgent' : daysLeft < 3 ? 'warning' : 'normal';
        %>
          <div class="deadline-badge <%= deadlineClass %> mt-2">
            Dự kiến giao: <%= new Date(request.expected_delivery_date).toLocaleDateString('vi-VN') %>
            <% if (daysLeft !== null) { %>
              <span>(<%= daysLeft > 0 ? 'Còn ' + daysLeft + ' ngày' : 'Quá hạn ' + Math.abs(daysLeft) + ' ngày' %>)</span>
            <% } %>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Request Details Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Main Info -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Thông tin yêu cầu</h2>
        
        <div class="space-y-4">
          <!-- Giai đoạn (Stage) -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Giai đoạn sản xuất</label>
            <p class="text-gray-900 font-semibold"><%= request.stage_name || 'Không xác định' %></p>
          </div>

          <!-- Người yêu cầu -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Người yêu cầu</label>
            <p class="text-gray-900">
              <%= request.requester_name %> 
              <span class="text-gray-600 text-sm">(<%= request.requester_role %>)</span>
            </p>
            <p class="text-gray-600 text-sm"><%= request.created_at ? new Date(request.created_at).toLocaleDateString('vi-VN', { 
              year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' 
            }) : 'N/A' %></p>
          </div>

          <!-- Nội dung yêu cầu -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Nội dung yêu cầu</label>
            <div class="bg-gray-50 rounded p-3 text-gray-900">
              <%= request.request_details %>
            </div>
          </div>

          <!-- Trạng thái giao dịch -->
          <% if (request.status !== 'pending') { %>
            <div class="border-t pt-4 mt-4">
              <label class="block text-sm font-semibold text-gray-700 mb-1">Thông tin xác nhận mua</label>
              <p class="text-gray-900">
                Nhân viên mua: <strong><%= request.purchaser_name %></strong>
              </p>
              <p class="text-gray-600 text-sm">
                <%= request.purchased_at ? new Date(request.purchased_at).toLocaleDateString('vi-VN', { 
                  year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' 
                }) : 'N/A' %>
              </p>
              <% if (request.expected_delivery_date) { %>
                <p class="text-gray-600 text-sm">
                  Dự kiến giao: <strong><%= new Date(request.expected_delivery_date).toLocaleDateString('vi-VN') %></strong>
                </p>
              <% } %>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Status Card -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Trạng thái</h2>
      
      <div class="space-y-3">
        <div class="flex items-center">
          <div class="w-4 h-4 rounded-full <%= request.status === 'pending' || request.status === 'purchased' || request.status === 'delivered' ? 'bg-green-500' : 'bg-gray-300' %> mr-3"></div>
          <span class="text-gray-700">Yêu cầu gửi đi</span>
        </div>
        
        <div class="flex items-center">
          <div class="w-4 h-4 rounded-full <%= request.status === 'purchased' || request.status === 'delivered' ? 'bg-green-500' : 'bg-gray-300' %> mr-3"></div>
          <span class="text-gray-700">Đã xác nhận mua</span>
        </div>
        
        <div class="flex items-center">
          <div class="w-4 h-4 rounded-full <%= request.status === 'delivered' ? 'bg-green-500' : 'bg-gray-300' %> mr-3"></div>
          <span class="text-gray-700">Đã giao hàng</span>
        </div>
      </div>

      <!-- Action Buttons -->
      <% if (role === 'THU_MUA' && request.status === 'pending') { %>
        <div class="mt-6 pt-4 border-t">
          <button 
            onclick="document.getElementById('confirmModal').classList.remove('hidden')"
            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition"
          >
            Xác nhận mua hàng
          </button>
        </div>
      <% } %>

      <% if (role === 'THU_MUA' && request.status === 'purchased') { %>
        <div class="mt-6 pt-4 border-t">
          <button 
            onclick="markDelivered(<%= request.id %>)"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition"
          >
            Đánh dấu đã giao
          </button>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Messages/Comments Section -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Bình luận & ghi chú</h2>

    <!-- Messages List -->
    <div class="messages-container mb-6 max-h-96 overflow-y-auto">
      <% if (messages && messages.length > 0) { %>
        <% messages.forEach(msg => { %>
          <div class="message-item <%= msg.is_purchaser ? 'from-purchaser' : 'from-department' %>">
            <div class="flex justify-between items-start mb-1">
              <strong class="text-gray-900"><%= msg.user_name %></strong>
              <span class="text-gray-500 text-sm">
                <%= new Date(msg.created_at).toLocaleDateString('vi-VN', { 
                  year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' 
                }) %>
              </span>
            </div>
            <div class="text-gray-700 whitespace-pre-wrap"><%= msg.message %></div>
            <% if (msg.role) { %>
              <span class="text-xs text-gray-600 mt-1 inline-block">(<%= msg.role %>)</span>
            <% } %>
          </div>
        <% }); %>
      <% } else { %>
        <p class="text-gray-600 text-center py-4">Chưa có bình luận nào</p>
      <% } %>
    </div>

    <!-- Add Comment Form -->
    <div class="border-t pt-4">
      <h3 class="font-semibold text-gray-800 mb-3">Thêm bình luận</h3>
      <div class="comment-form">
        <textarea 
          id="commentInput" 
          class="w-full border border-gray-300 rounded px-3 py-2 text-gray-900 focus:outline-none focus:border-blue-500"
          placeholder="Nhập bình luận..."
        ></textarea>
        <button 
          onclick="sendComment(<%= request.id %>)"
          class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded transition"
        >
          Gửi bình luận
        </button>
      </div>
    </div>
  </div>

  <!-- Confirm Purchase Modal -->
  <% if (role === 'THU_MUA') { %>
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Xác nhận mua hàng</h2>
        
        <form id="confirmForm">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                Dự kiến ngày giao hàng <span class="text-red-600">*</span>
              </label>
              <input 
                type="date" 
                id="expected_delivery_date"
                required
                class="w-full border border-gray-300 rounded px-3 py-2 text-gray-900 focus:outline-none focus:border-blue-500"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                Ghi chú
              </label>
              <textarea 
                id="response_note"
                class="w-full border border-gray-300 rounded px-3 py-2 text-gray-900 focus:outline-none focus:border-blue-500"
                placeholder="Thêm ghi chú (không bắt buộc)"
                rows="3"
              ></textarea>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button 
              type="button"
              onclick="document.getElementById('confirmModal').classList.add('hidden')"
              class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded transition"
            >
              Hủy
            </button>
            <button 
              type="button"
              onclick="confirmPurchase(<%= request.id %>)"
              class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition"
            >
              Xác nhận
            </button>
          </div>
        </form>
      </div>
    </div>
  <% } %>

</div>

<script>
async function sendComment(requestId) {
  const message = document.getElementById('commentInput').value.trim();
  
  if (!message) {
    alert('Vui lòng nhập bình luận');
    return;
  }

  try {
    const response = await fetch(`/purchasing/request/${requestId}/message`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    });

    if (response.ok) {
      document.getElementById('commentInput').value = '';
      // Reload comments
      location.reload();
    } else {
      alert('Lỗi khi gửi bình luận');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Lỗi khi gửi bình luận');
  }
}

async function confirmPurchase(requestId) {
  const expected_delivery_date = document.getElementById('expected_delivery_date').value;
  const response_note = document.getElementById('response_note').value;

  if (!expected_delivery_date) {
    alert('Vui lòng chọn ngày dự kiến giao hàng');
    return;
  }

  try {
    const res = await fetch('/purchasing/confirm', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        requestId,
        expected_delivery_date,
        response_note
      })
    });

    if (res.ok) {
      alert('Đã xác nhận mua hàng');
      location.reload();
    } else {
      const error = await res.json();
      alert(error.error || 'Lỗi khi xác nhận mua');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Lỗi khi xác nhận mua');
  }
}

async function markDelivered(requestId) {
  if (confirm('Bạn chắc chắn đã giao hàng?')) {
    try {
      const response = await fetch('/purchasing/delivered', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ requestId })
      });

      if (response.ok) {
        alert('Đã cập nhật trạng thái');
        location.reload();
      } else {
        alert('Lỗi khi cập nhật trạng thái');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Lỗi khi cập nhật trạng thái');
    }
  }
}
</script>

<%- include('../footer') %>
