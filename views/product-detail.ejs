<%- include('header') %>

<div class="mb-6">
  <a href="/workflow/worker-dashboard" class="text-purple-600 hover:text-purple-800">
    <i class="fas fa-arrow-left mr-2"></i>Quay lại Dashboard
  </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Main Info -->
  <div class="lg:col-span-2">
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-4"><%= product.product_code %></h1>
      <h2 class="text-2xl text-gray-600 mb-6"><%= product.product_name %></h2>

      <div class="grid grid-cols-3 gap-4 mb-8">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
          <p class="text-gray-600 text-sm mb-1">Khâu Hiện Tại</p>
          <p class="text-2xl font-bold text-blue-800"><%= product.stage_name %></p>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg">
          <p class="text-gray-600 text-sm mb-1">Trạng Thái</p>
          <% 
            let statusText = '';
            if (product.status === 'pending') statusText = '⏸️ CHỜ ĐỢI';
            else if (product.status === 'processing') statusText = '⏱️ ĐANG LÀM';
            else if (product.status === 'completed') statusText = '✅ HOÀN THÀNH';
          %>
          <p class="text-lg font-bold text-purple-800"><%= statusText %></p>
        </div>
        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
          <p class="text-gray-600 text-sm mb-1">Ngày Tạo</p>
          <p class="text-lg font-bold text-green-800"><%= new Date(product.created_at).toLocaleDateString('vi-VN') %></p>
        </div>
      </div>
    </div>

    <!-- Project Timeline -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-6">Tiến Trình Công Đoạn</h2>
      
      <div class="space-y-4">
        <% if (tasks && tasks.length > 0) { %>
          <% tasks.forEach((task, index) => { %>
            <div class="flex items-start">
              <div class="flex flex-col items-center mr-6">
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-white
                  <%= task.status === 'completed' ? 'bg-green-500' : (task.status === 'processing' ? 'bg-blue-500' : 'bg-gray-300') %>">
                  <% if (task.status === 'completed') { %>
                    <i class="fas fa-check"></i>
                  <% } else { %>
                    <%= index + 1 %>
                  <% } %>
                </div>
                <% if (index < tasks.length - 1) { %>
                  <div class="w-1 h-12 bg-gray-300 my-1"></div>
                <% } %>
              </div>
              
              <div class="flex-1 pt-1">
                <p class="font-bold text-lg text-gray-800"><%= task.stage_name %></p>
                <p class="text-sm text-gray-600">Định mức: <strong><%= task.norm_hours %>h</strong></p>
                
                <% if (task.status === 'completed') { %>
                  <div class="mt-2 bg-green-50 p-3 rounded text-sm text-green-800 border-l-4 border-green-500">
                    <p><i class="fas fa-check-circle mr-2"></i>Hoàn thành</p>
                    <% if (task.start_time && task.end_time) { %>
                      <p class="text-xs mt-1">
                        Từ: <%= new Date(task.start_time).toLocaleString('vi-VN') %><br>
                        Đến: <%= new Date(task.end_time).toLocaleString('vi-VN') %>
                      </p>
                    <% } %>
                  </div>
                <% } else if (task.status === 'processing') { %>
                  <div class="mt-2 bg-blue-50 p-3 rounded text-sm text-blue-800 border-l-4 border-blue-500">
                    <p><i class="fas fa-spinner mr-2"></i>Đang xử lý</p>
                    <% if (task.start_time) { %>
                      <p class="text-xs mt-1">Bắt đầu: <%= new Date(task.start_time).toLocaleString('vi-VN') %></p>
                    <% } %>
                    <% if (task.assigned_user) { %>
                      <p class="text-xs">Người thực hiện: <strong><%= task.assigned_user %></strong></p>
                    <% } %>
                  </div>
                <% } else { %>
                  <div class="mt-2 bg-yellow-50 p-3 rounded text-sm text-yellow-800 border-l-4 border-yellow-500">
                    <i class="fas fa-pause-circle mr-2"></i>Chờ đợi
                  </div>
                <% } %>
              </div>
            </div>
          <% }); %>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Sidebar Stats -->
  <div>
    <!-- Product Stats -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">Thống Kê</h2>
      <div class="space-y-4">
        <div class="border-l-4 border-green-500 pl-4 py-2">
          <p class="text-gray-600 text-sm">Khâu Hoàn Thành</p>
          <p class="text-2xl font-bold text-green-600">
            <%= tasks ? tasks.filter(t => t.status === 'completed').length : 0 %>/<%= tasks ? tasks.length : 0 %>
          </p>
        </div>
        <div class="border-l-4 border-blue-500 pl-4 py-2">
          <p class="text-gray-600 text-sm">Thời Gian Trôi</p>
          <p class="text-2xl font-bold text-blue-600">
            <% 
              const created = new Date(product.created_at);
              const now = new Date();
              const hours = Math.floor((now - created) / (1000 * 60 * 60));
            %>
            <%= hours %>h
          </p>
        </div>
        <div class="border-l-4 border-purple-500 pl-4 py-2">
          <p class="text-gray-600 text-sm">Tổng Định Mức</p>
          <p class="text-2xl font-bold text-purple-600">
            <%= tasks ? tasks.reduce((sum, t) => sum + t.norm_hours, 0) : 0 %>h
          </p>
        </div>
      </div>
    </div>

    <!-- Activity Log -->
    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-lg font-bold text-gray-800 mb-4">Nhật Ký Hoạt Động</h2>
      <div class="space-y-3 max-h-96 overflow-y-auto">
        <% if (logs && logs.length > 0) { %>
          <% logs.forEach(log => { %>
            <div class="bg-gray-50 p-3 rounded text-sm border-l-4 border-purple-300">
              <p class="font-semibold text-gray-800"><%= log.action %></p>
              <% if (log.details && log.details.reason) { %>
                <p class="text-sm text-gray-700 mt-1">Lý do: <strong><%= log.details.reason %></strong></p>
              <% } %>
              <p class="text-gray-600 text-xs"><%= log.full_name %></p>
              <p class="text-gray-500 text-xs"><%= new Date(log.created_at).toLocaleString('vi-VN') %></p>
            </div>
          <% }); %>
        <% } else { %>
          <p class="text-gray-500 text-sm text-center py-4">Không có hoạt động nào</p>
        <% } %>
      </div>
    </div>
  </div>
</div>

<%- include('footer') %>
