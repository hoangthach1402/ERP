<%- include('../header') %>

<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <div class="mb-8 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">My Tasks</h1>
        <p class="mt-2 text-sm text-gray-600">C√¥ng vi·ªác ƒë∆∞·ª£c g√°n cho b·∫°n</p>
      </div>
    </div>

    <!-- Filter Tabs -->
    <div class="mb-6">
      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
          <button onclick="loadTasks('all')" class="tab-button active border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-status="all">
            All Tasks
          </button>
          <button onclick="loadTasks('assigned')" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-status="assigned">
            Assigned
          </button>
          <button onclick="loadTasks('working')" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-status="working">
            Working
          </button>
          <button onclick="loadTasks('completed')" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-status="completed">
            Completed
          </button>
        </nav>
      </div>
    </div>

    <!-- Tasks List -->
    <div id="tasksList" class="space-y-4">
      <!-- Tasks will be loaded here -->
    </div>

  </div>
</div>

<script>
// Get token from server-side render
const authToken = '<%= typeof token !== "undefined" ? token : "" %>';

let currentStatus = null;

// Load tasks
async function loadTasks(status = null) {
  currentStatus = status === 'all' ? null : status;
  
  // Show loading state
  const container = document.getElementById('tasksList');
  container.innerHTML = `
    <div class="bg-white rounded-lg shadow p-8 text-center">
      <svg class="animate-spin mx-auto h-12 w-12 text-indigo-600" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="mt-4 text-gray-500">Loading tasks...</p>
    </div>
  `;
  
  try {
    const url = status && status !== 'all' 
      ? `/workflow/my-tasks?status=${status}` 
      : '/workflow/my-tasks';
    
    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      }
    });
    
    if (!response.ok) {
      if (response.status === 401) {
        // Redirect to login if not authenticated
        window.location.href = '/login';
        return;
      }
      throw new Error('Failed to load tasks');
    }
    
    const result = await response.json();
    const tasks = result.data || [];
    
    // Update tabs
    document.querySelectorAll('.tab-button').forEach(btn => {
      const btnStatus = btn.getAttribute('data-status');
      if (btnStatus === (status || 'all')) {
        btn.classList.remove('border-transparent', 'text-gray-500');
        btn.classList.add('border-indigo-500', 'text-indigo-600');
      } else {
        btn.classList.remove('border-indigo-500', 'text-indigo-600');
        btn.classList.add('border-transparent', 'text-gray-500');
      }
    });
    
    // Render tasks
    const container = document.getElementById('tasksList');
    container.innerHTML = '';
    
    if (tasks.length === 0) {
      container.innerHTML = `
        <div class="bg-white rounded-lg shadow p-8 text-center">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          <p class="mt-4 text-gray-500">No tasks found</p>
        </div>
      `;
      return;
    }
    
    tasks.forEach(task => {
      const taskCard = createTaskCard(task);
      container.appendChild(taskCard);
      
      // Render chart for working tasks
      if (task.status === 'working') {
        setTimeout(() => {
          renderHoursChart(task);
        }, 100);
      }
      
      // Load material requests for all tasks
      setTimeout(() => {
        loadMaterialRequests(task.product_id, task.stage_id);
      }, 150);
    });
    
  } catch (error) {
    console.error('Error loading tasks:', error);
    // Show error message in the tasks list
    const container = document.getElementById('tasksList');
    if (container) {
      container.innerHTML = `
        <div class="bg-red-50 rounded-lg shadow p-8 text-center">
          <svg class="mx-auto h-12 w-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <p class="mt-4 text-red-600 font-medium">Failed to load tasks</p>
          <p class="mt-2 text-sm text-gray-600">${error.message}</p>
          <button onclick="loadTasks(currentStatus)" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
            Retry
          </button>
        </div>
      `;
    }
  }
}

// Create task card
function createTaskCard(task) {
  const card = document.createElement('div');
  card.className = 'bg-white rounded-lg shadow p-6';
  card.id = `task-${task.product_id}-${task.stage_id}`;
  
  const statusBadge = getStatusBadge(task.status);
  const actions = getTaskActions(task);
  
  card.innerHTML = `
    <div class="flex flex-col space-y-4">
      <!-- Header Row with Chart -->
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <div class="flex items-center">
            <h3 class="text-lg font-semibold text-gray-900">${task.product_code}</h3>
            <span class="ml-3 ${statusBadge.class}">${statusBadge.text}</span>
            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              ${task.stage_name}
            </span>
          </div>
          <p class="mt-1 text-sm text-gray-600">${task.product_name}</p>
        </div>
        
        ${task.status === 'working' ? `
          <div style="width: 120px; height: 120px; margin-left: 20px; flex-shrink: 0;">
            <canvas id="chart-${task.product_id}-${task.stage_id}"></canvas>
          </div>
        ` : ''}
        
        <div class="ml-4 flex flex-col space-y-2">
          ${actions}
        </div>
      </div>
      
      <!-- Details Row -->
      <div class="grid grid-cols-3 gap-4 text-sm">
        ${task.start_time ? `
          <div>
            <span class="text-gray-500">Started:</span>
            <span class="ml-2 text-gray-900">${new Date(task.start_time).toLocaleString()}</span>
          </div>
        ` : ''}
        ${task.hours_worked && task.status === 'completed' ? `
          <div>
            <span class="text-gray-500">Hours worked:</span>
            <span class="ml-2 text-gray-900">${Math.round(task.hours_worked * 10) / 10}h</span>
          </div>
        ` : ''}
        ${task.end_time ? `
          <div>
            <span class="text-gray-500">Completed:</span>
            <span class="ml-2 text-gray-900">${new Date(task.end_time).toLocaleString()}</span>
          </div>
        ` : ''}
      </div>
      
      ${task.notes ? `
        <div class="p-3 bg-yellow-50 rounded-md">
          <p class="text-sm text-gray-700"><strong>Notes:</strong> ${task.notes}</p>
        </div>
      ` : ''}
      
      <!-- Material Requests Section -->
      <div id="materialRequests-${task.product_id}-${task.stage_id}" class="mt-4 border-t pt-4">
        <div class="flex justify-between items-center mb-3">
          <h4 class="font-semibold text-gray-900">üõí Y√™u C·∫ßu Mua H√†ng</h4>
          <button onclick="loadMaterialRequests(${task.product_id}, ${task.stage_id})" class="text-xs text-blue-600 hover:text-blue-800">
            <i class="fas fa-sync"></i>
          </button>
        </div>
        <div id="materialRequestsList-${task.product_id}-${task.stage_id}" class="space-y-2 text-sm">
          <p class="text-gray-500 italic">Loading...</p>
        </div>
      </div>
    </div>
  `;
  
  return card;
}

// Get status badge
function getStatusBadge(status) {
  const badges = {
    'assigned': { class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800', text: 'Assigned' },
    'working': { class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800', text: 'Working' },
    'completed': { class: 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800', text: 'Completed' }
  };
  return badges[status] || badges['assigned'];
}

// Get task actions
function getTaskActions(task) {
  if (task.status === 'assigned') {
    return `
      <button onclick="startWork(${task.product_id}, ${task.stage_id})" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm font-medium">Start Work</button>
      <button onclick="assignWorkersModal(${task.product_id}, ${task.stage_id}, '${task.product_code}', '${task.stage_name}')" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium">Assign Workers</button>
      <button onclick="openMaterialRequestModal(${task.product_id}, '${task.product_code}', '${task.stage_name}')" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 text-sm font-medium">Request Material</button>
    `;
  } else if (task.status === 'working') {
    return `
      <button onclick="completeWork(${task.product_id}, ${task.stage_id})" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium">Complete</button>
      <button onclick="pauseWork(${task.product_id}, ${task.stage_id})" class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 text-sm font-medium">Pause</button>
      <button onclick="assignWorkersModal(${task.product_id}, ${task.stage_id}, '${task.product_code}', '${task.stage_name}')" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium">Assign Workers</button>
      <button onclick="openMaterialRequestModal(${task.product_id}, '${task.product_code}', '${task.stage_name}')" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 text-sm font-medium">Request Material</button>
    `;
  } else {
    return `<span class="text-sm text-gray-500">Task completed</span>`;
  }
}

// Start work
async function startWork(productId, stageId) {
  try {
    const response = await fetch('/workflow/start-work', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify({ productId, stageId })
    });
    
    if (!response.ok) throw new Error('Failed to start work');
    
    alert('Work started successfully!');
    loadTasks(currentStatus);
    
  } catch (error) {
    console.error('Error starting work:', error);
    alert('Failed to start work');
  }
}

// Complete work
async function completeWork(productId, stageId) {
  const notes = prompt('Add notes (optional):');
  
  try {
    const response = await fetch('/workflow/complete-work', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify({ productId, stageId, notes })
    });
    
    if (!response.ok) throw new Error('Failed to complete work');
    
    alert('Work completed successfully!');
    loadTasks(currentStatus);
    
  } catch (error) {
    console.error('Error completing work:', error);
    alert('Failed to complete work');
  }
}

// Pause work
async function pauseWork(productId, stageId) {
  const reason = prompt('Reason for pausing:');
  if (!reason) return;
  
  try {
    const response = await fetch('/workflow/pause-work', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify({ productId, stageId, reason })
    });
    
    if (!response.ok) throw new Error('Failed to pause work');
    
    alert('Work paused successfully!');
    loadTasks(currentStatus);
    
  } catch (error) {
    console.error('Error pausing work:', error);
    alert('Failed to pause work');
  }
}

// Render hours chart
function renderHoursChart(task) {
  const chartId = `chart-${task.product_id}-${task.stage_id}`;
  const canvasElement = document.getElementById(chartId);
  
  if (!canvasElement) return;
  
  // Calculate hours
  const yourHours = Math.round(task.hours_elapsed * 10) / 10;
  const stageTotal = Math.round(task.stage_total_hours * 10) / 10;
  const otherHours = Math.max(0, stageTotal - yourHours);
  const remainingHours = Math.max(0, task.norm_hours - stageTotal);
  
  // Destroy existing chart if any
  if (window.charts && window.charts[chartId]) {
    window.charts[chartId].destroy();
  }
  
  if (!window.charts) {
    window.charts = {};
  }
  
  const ctx = canvasElement.getContext('2d');
  const chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: [
        `${yourHours}h`,
        `${otherHours}h`,
        `${remainingHours}h`
      ],
      datasets: [{
        data: [yourHours, otherHours, remainingHours],
        backgroundColor: [
          '#3b82f6', // Blue for your hours
          '#60a5fa', // Light blue for others
          '#d1d5db'  // Gray for remaining
        ],
        borderColor: [
          '#ffffff',
          '#ffffff',
          '#ffffff'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.label + ': ' + context.parsed + 'h';
            }
          }
        }
      }
    }
  });
  
  window.charts[chartId] = chart;
}

// Material Request Modal Functions
function openMaterialRequestModal(productId, productCode, stageName) {
  const modal = document.getElementById('materialRequestModal');
  document.getElementById('modalProductCode').textContent = productCode;
  document.getElementById('modalStageName').textContent = stageName;
  document.getElementById('requestProductId').value = productId;
  document.getElementById('requestStage').value = stageName;
  modal.classList.remove('hidden');
}

// Load and display material requests for a stage
async function loadMaterialRequests(productId, stageId) {
  try {
    const response = await fetch(`/workflow/product/${productId}/stage/${stageId}/material-requests`, {
      headers: { 'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}` }
    });

    if (!response.ok) throw new Error('Failed to load material requests');
    const data = await response.json();
    const requests = data.data || [];

    const container = document.getElementById(`materialRequestsList-${productId}-${stageId}`);
    if (!container) return;

    if (requests.length === 0) {
      container.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ y√™u c·∫ßu mua h√†ng</p>';
      return;
    }

    container.innerHTML = requests.map(req => {
      const statusColors = {
        'pending': 'bg-yellow-100 text-yellow-800',
        'purchased': 'bg-green-100 text-green-800',
        'delivered': 'bg-blue-100 text-blue-800'
      };
      const statusText = {
        'pending': 'Ch·ªù',
        'purchased': 'ƒê√£ Mua',
        'delivered': 'ƒê√£ Nh·∫≠n'
      };

      return `
        <div class="p-3 border rounded-lg bg-orange-50 cursor-pointer" onclick="event.stopPropagation(); expandMaterialRequest(this, ${req.id})">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <p class="font-semibold text-gray-900 text-sm">${req.reason || 'Y√™u c·∫ßu'}</p>
              <p class="text-xs text-gray-600 mt-1">Y√™u c·∫ßu b·ªüi: ${req.requested_by_name}</p>
            </div>
            <span class="px-2 py-1 text-xs font-semibold rounded ${statusColors[req.status] || statusColors.pending}">
              ${statusText[req.status] || req.status}
            </span>
          </div>
          <div id="materialRequestDetail-${req.id}" class="hidden mt-3 space-y-2 border-t pt-2" style="display:none;">
            <p class="text-xs text-gray-600"><strong>Tr·∫°ng th√°i:</strong> ${req.status}</p>
            ${req.purchased_by_name ? `<p class="text-xs text-gray-600"><strong>X·ª≠ l√Ω b·ªüi:</strong> ${req.purchased_by_name}</p>` : ''}
            ${req.expected_delivery_date ? `<p class="text-xs text-gray-600"><strong>D·ª± ki·∫øn giao:</strong> ${new Date(req.expected_delivery_date).toLocaleDateString('vi-VN')}</p>` : ''}
            <textarea id="commentInput-${req.id}" class="w-full p-2 text-xs border rounded" placeholder="Th√™m b√¨nh lu·∫≠n..." onclick="event.stopPropagation()"></textarea>
            <button onclick="event.stopPropagation(); addMaterialRequestComment(${req.id})" class="w-full px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">
              G·ª≠i B√¨nh Lu·∫≠n
            </button>
            <div id="comments-${req.id}" class="text-xs space-y-1 max-h-24 overflow-y-auto"></div>
          </div>
        </div>
      `;
    }).join('');

  } catch (error) {
    console.error('Error loading material requests:', error);
    const container = document.getElementById(`materialRequestsList-${productId}-${stageId}`);
    if (container) {
      container.innerHTML = `<p class="text-red-500 text-xs">L·ªói: ${error.message}</p>`;
    }
  }
}

// Expand/collapse material request details
function expandMaterialRequest(element, requestId) {
  const detail = document.getElementById(`materialRequestDetail-${requestId}`);
  if (detail) {
    detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
  }
}

// Add comment to material request
async function addMaterialRequestComment(requestId) {
  const commentInput = document.getElementById(`commentInput-${requestId}`);
  const comment = commentInput.value.trim();

  if (!comment) {
    alert('Vui l√≤ng nh·∫≠p b√¨nh lu·∫≠n');
    return;
  }

  try {
    const response = await fetch(`/workflow/material-request/${requestId}/update`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify({ comment })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    commentInput.value = '';
    alert('B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c th√™m!');
    // Reload tasks to refresh material requests
    loadTasks(currentStatus);

  } catch (error) {
    console.error('Error adding comment:', error);
    alert('L·ªói: ' + error.message);
  }
}

function closeMaterialRequestModal() {
  const modal = document.getElementById('materialRequestModal');
  modal.classList.add('hidden');
  document.getElementById('materialRequestForm').reset();
}

async function submitMaterialRequest(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const data = {
    productId: parseInt(formData.get('productId')),
    stage: formData.get('stage'),
    materials: formData.get('materials'),
    quantity: parseInt(formData.get('quantity')),
    urgency: formData.get('urgency'),
    notes: formData.get('notes')
  };
  
  try {
    const response = await fetch('/purchasing/request/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify(data)
    });
    
    if (!response.ok) throw new Error('Failed to create material request');
    
    alert('Material request submitted successfully!');
    closeMaterialRequestModal();
    
  } catch (error) {
    console.error('Error submitting material request:', error);
    alert('Failed to submit material request');
  }
}

// Assign workers modal
let currentAssignProductId = null;
let currentAssignStageId = null;
let currentAssignProductCode = '';
let currentAssignStageName = '';
let availableAssignWorkers = [];

async function assignWorkersModal(productId, stageId, productCode, stageName) {
  currentAssignProductId = productId;
  currentAssignStageId = stageId;
  currentAssignProductCode = productCode;
  currentAssignStageName = stageName;
  
  try {
    // Fetch assigned workers for this stage
    const assignedResponse = await fetch(`/workflow/assigned-workers/${productId}/${stageId}`, {
      headers: {
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      }
    });
    
    if (!assignedResponse.ok) throw new Error('Failed to fetch assigned workers');
    const assignedData = await assignedResponse.json();
    const assignedWorkerIds = (assignedData.data || []).map(w => w.user_id);
    
    // Fetch available workers for this stage (role-based filtering)
    const workersResponse = await fetch(`/workflow/available-workers/${productId}/${stageId}`, {
      headers: {
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      }
    });
    
    if (!workersResponse.ok) throw new Error('Failed to fetch available workers');
    const workersData = await workersResponse.json();
    availableAssignWorkers = workersData.data || [];
    
    // Update modal content
    document.getElementById('assignWorkerProductCode').textContent = productCode;
    document.getElementById('assignWorkerStageName').textContent = stageName;
    
    // Populate workers checkboxes
    const workersContainer = document.getElementById('assignWorkersList');
    workersContainer.innerHTML = '';
    if (availableAssignWorkers.length === 0) {
      workersContainer.innerHTML = '<p class="text-gray-500 text-sm">No available workers from this stage</p>';
    } else {
      availableAssignWorkers.forEach(user => {
        const isAssigned = assignedWorkerIds.includes(user.id);
        const label = document.createElement('label');
        label.className = `flex items-center p-2 rounded ${isAssigned ? 'bg-green-50 border border-green-200' : 'hover:bg-gray-50'}`;
        label.innerHTML = `
          <input type="checkbox" name="assignWorker" value="${user.id}" ${isAssigned ? 'checked disabled' : ''} class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${isAssigned ? 'style="cursor:not-allowed"' : ''}>
          <span class="ml-2 text-sm">${user.full_name} (${user.username}) - <span class="text-xs text-gray-500">${user.role}</span>${isAssigned ? ' <span class="ml-2 inline-block px-2 py-0.5 text-xs bg-green-200 text-green-800 rounded-full font-medium">Already assigned</span>' : ''}</span>
        `;
        workersContainer.appendChild(label);
      });
    }
    
    // Show modal
    document.getElementById('assignWorkersWorkerModal').classList.remove('hidden');
    
  } catch (error) {
    console.error('Error opening assign workers modal:', error);
    alert('Failed to load available workers: ' + error.message);
  }
}

function closeAssignWorkersWorkerModal() {
  document.getElementById('assignWorkersWorkerModal').classList.add('hidden');
  document.getElementById('assignWorkersWorkerForm').reset();
}

async function submitAssignWorkers(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const selectedWorkers = formData.getAll('assignWorker').map(id => parseInt(id));
  
  if (selectedWorkers.length === 0) {
    alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 worker');
    return;
  }
  
  try {
    const response = await fetch('/workflow/assign-workers', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify({
        productId: currentAssignProductId,
        stageId: currentAssignStageId,
        userIds: selectedWorkers
      })
    });
    
    if (!response.ok) throw new Error('Failed to assign workers');
    
    alert('Workers assigned successfully!');
    closeAssignWorkersWorkerModal();
    loadTasks(currentStatus); // Refresh data
    
  } catch (error) {
    console.error('Error assigning workers:', error);
    alert('Failed to assign workers: ' + error.message);
  }
}

// Load tasks on page load
document.addEventListener('DOMContentLoaded', () => loadTasks('all'));
</script>

<!-- Assign Workers Modal -->
<div id="assignWorkersWorkerModal" class="hidden fixed z-50 inset-0 overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeAssignWorkersWorkerModal()"></div>
    
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <form id="assignWorkersWorkerForm" onsubmit="submitAssignWorkers(event)">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
              <i class="fas fa-users text-blue-600"></i>
            </div>
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
              <h3 class="text-lg leading-6 font-medium text-gray-900">Assign Workers</h3>
              <p class="text-sm text-gray-500 mt-1">
                Product: <span id="assignWorkerProductCode" class="font-semibold"></span> - 
                Stage: <span id="assignWorkerStageName" class="font-semibold"></span>
              </p>
              
              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Workers *</label>
                <div id="assignWorkersList" class="max-h-64 overflow-y-auto border rounded-md p-2 space-y-1">
                  <!-- Workers will be populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button 
            type="submit"
            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
            Assign Workers
          </button>
          <button 
            type="button"
            onclick="closeAssignWorkersWorkerModal()"
            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Material Request Modal -->
<div id="materialRequestModal" class="hidden fixed z-50 inset-0 overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeMaterialRequestModal()"></div>
    
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <form id="materialRequestForm" onsubmit="submitMaterialRequest(event)">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-purple-100 sm:mx-0 sm:h-10 sm:w-10">
              <i class="fas fa-box text-purple-600"></i>
            </div>
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
              <h3 class="text-lg leading-6 font-medium text-gray-900">Request Material</h3>
              <p class="text-sm text-gray-500 mt-1">
                Product: <span id="modalProductCode" class="font-semibold"></span> - 
                Stage: <span id="modalStageName" class="font-semibold"></span>
              </p>
              
              <input type="hidden" name="productId" id="requestProductId">
              <input type="hidden" name="stage" id="requestStage">
              
              <div class="mt-4 space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">Materials Needed *</label>
                  <textarea 
                    name="materials" 
                    required
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"
                    placeholder="Describe the materials needed..."></textarea>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700">Quantity *</label>
                  <input 
                    type="number" 
                    name="quantity" 
                    required
                    min="1"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"
                    placeholder="Enter quantity">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700">Urgency *</label>
                  <select 
                    name="urgency" 
                    required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm">
                    <option value="low">Low - Can wait</option>
                    <option value="medium" selected>Medium - Needed soon</option>
                    <option value="high">High - Urgent</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700">Notes</label>
                  <textarea 
                    name="notes" 
                    rows="2"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"
                    placeholder="Additional notes (optional)"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button 
            type="submit"
            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-purple-600 text-base font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:ml-3 sm:w-auto sm:text-sm">
            Submit Request
          </button>
          <button 
            type="button"
            onclick="closeMaterialRequestModal()"
            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<%- include('../footer') %>
