<!-- Apply Fixed Header for Mobile -->
<style>
  @media (max-width: 767px) {
    nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      z-index: 50;
    }
  }
</style>

<%- include('../header') %>

<!-- Mobile Layout -->
<div class="md:hidden flex flex-col bg-white bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen" style="padding-top: 140px; margin-top: 20px;">
  <!-- Scrollable Task Content -->
  <div id="tasksList" class="flex-1 overflow-y-auto scroll-smooth pb-36">
    <!-- Tasks will be loaded here -->
  </div>
  
  <!-- Fixed Action Bar at Bottom -->
  <div id="mobileActionBar" class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-gray-100 shadow-2xl md:hidden z-50">
    <div class="grid grid-cols-2 gap-0 p-0" id="actionButtonsContainer">
      <!-- Action buttons will be populated here -->
    </div>
  </div>
</div>

<!-- Desktop Layout -->
<div class="hidden md:block min-h-screen bg-gray-50 py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">My Tasks</h1>
    </div>

    <!-- Filter Tabs -->
    <div class="mb-6">
      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
          <button onclick="loadTasks('assigned')" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-status="assigned">
            Assigned
          </button>
          <button onclick="loadTasks('working')" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-status="working">
            Working
          </button>
          <button onclick="loadTasks('completed')" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-status="completed">
            Completed
          </button>
        </nav>
      </div>
    </div>

    <!-- Tasks List -->
    <div id="tasksListDesktop" class="space-y-4">
      <!-- Tasks will be loaded here -->
    </div>
  </div>
</div>

<script>
// Get token from server-side render
const authToken = '<%= typeof token !== "undefined" ? token : "" %>';

let currentStatus = null;
let currentTask = null;
let taskCounts = { assigned: 0, working: 0, completed: 0 };

// Fetch task counts and update badges
async function updateTaskCounts() {
  try {
    const response = await fetch('/workflow/task-counts', {
      headers: {
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      }
    });
    
    if (response.ok) {
      taskCounts = await response.json();
      // Update count badges on dropdown (in header)
      const countAssigned = document.getElementById('dropdown-count-assigned');
      const countWorking = document.getElementById('dropdown-count-working');
      const countCompleted = document.getElementById('dropdown-count-completed');
      
      if (countAssigned) countAssigned.textContent = taskCounts.assigned || 0;
      if (countWorking) countWorking.textContent = taskCounts.working || 0;
      if (countCompleted) countCompleted.textContent = taskCounts.completed || 0;
    }
  } catch (error) {
    console.error('Error fetching task counts:', error);
  }
}

// Toggle dropdown menu
function toggleTasksDropdown(e) {
  if (e) {
    e.preventDefault();
    e.stopPropagation();
  }
  const dropdown = document.getElementById('taskStatusDropdown');
  if (dropdown) {
    dropdown.classList.toggle('hidden');
  }
}

// Close dropdown menu
function closeTasksDropdown() {
  const dropdown = document.getElementById('taskStatusDropdown');
  if (dropdown) {
    dropdown.classList.add('hidden');
  }
}

// Go to tasks with status filter
function goToTasks(status) {
  loadTasks(status);
  closeTasksDropdown();
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('taskStatusDropdown');
  const btn = document.getElementById('myTasksBtn');
  if (dropdown && btn && !dropdown.contains(event.target) && !btn.contains(event.target)) {
    dropdown.classList.add('hidden');
  }
});

// Load tasks
async function loadTasks(status = null) {
  currentStatus = status || 'assigned';
  
  // Determine which container to use
  const isMobile = window.innerWidth < 768;
  const container = isMobile ? document.getElementById('tasksList') : document.getElementById('tasksListDesktop');
  
  if (!container) {
    console.error('Tasks container not found');
    return;
  }
  
  // Show loading state
  container.innerHTML = `
    <div class="bg-white rounded-lg shadow p-8 text-center">
      <svg class="animate-spin mx-auto h-12 w-12 text-indigo-600" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="mt-4 text-gray-500">Loading tasks...</p>
    </div>
  `;
  
  try {
    const url = status ? `/workflow/my-tasks?status=${status}` : '/workflow/my-tasks';
    
    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      }
    });
    
    if (!response.ok) {
      if (response.status === 401) {
        window.location.href = '/login';
        return;
      }
      throw new Error('Failed to load tasks');
    }
    
    const result = await response.json();
    const tasks = result.data || [];
    
    // Update tabs - new design for mobile tabs
    document.querySelectorAll('.tab-button').forEach(btn => {
      const btnStatus = btn.getAttribute('data-status');
      if (btnStatus === status) {
        btn.classList.remove('border-transparent', 'text-gray-600');
        btn.classList.add('border-indigo-500', 'text-indigo-700', 'bg-indigo-50');
      } else {
        btn.classList.remove('border-indigo-500', 'text-indigo-700', 'bg-indigo-50');
        btn.classList.add('border-transparent', 'text-gray-600');
      }
    });
    
    // Render tasks
    const isMobile = window.innerWidth < 768;
    const renderContainer = isMobile ? document.getElementById('tasksList') : document.getElementById('tasksListDesktop');
    renderContainer.innerHTML = '';
    
    if (tasks.length === 0) {
      renderContainer.innerHTML = `
        <div class="bg-white rounded-lg shadow p-8 text-center">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
          <p class="mt-4 text-gray-500">No tasks found</p>
        </div>
      `;
      return;
    }
    
    tasks.forEach(task => {
      const taskCard = createTaskCard(task, isMobile);
      renderContainer.appendChild(taskCard);
      
      // Render chart for working tasks
      if (task.status === 'working') {
        setTimeout(() => {
          renderHoursChart(task);
        }, 100);
      }
      
      // Load material requests for all tasks
      setTimeout(() => {
        loadMaterialRequests(task.product_id, task.stage_id);
      }, 150);
    });
    
    // On mobile, auto-select first task and update action buttons
    if (isMobile && tasks.length > 0) {
      setTimeout(() => {
        console.log('Auto-selecting first task:', tasks[0]);
        selectTask(tasks[0]);
      }, 200);
    } else if (isMobile) {
      console.log('No tasks to auto-select, clearing buttons');
      updateActionButtons();
    }
    
    // Set up scroll tracking for mobile buttons
    if (isMobile) {
      setTimeout(() => {
        setupTaskScrollTracking();
      }, 300);
    }
    
  } catch (error) {
    console.error('Error loading tasks:', error);
    // Show error message in the tasks list
    const container = document.getElementById('tasksList');
    if (container) {
      container.innerHTML = `
        <div class="bg-red-50 rounded-lg shadow p-8 text-center">
          <svg class="mx-auto h-12 w-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <p class="mt-4 text-red-600 font-medium">Failed to load tasks</p>
          <p class="mt-2 text-sm text-gray-600">${error.message}</p>
          <button onclick="loadTasks(currentStatus)" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
            Retry
          </button>
        </div>
      `;
    }
  }
}

// Select task and update action buttons (mobile only)
function selectTask(task) {
  console.log('selectTask called with:', task);
  currentTask = task;
  updateActionButtons();
  
  // Highlight selected task on mobile
  if (window.innerWidth < 768) {
    document.querySelectorAll('#tasksList .task-card').forEach(el => {
      el.classList.remove('ring-2', 'ring-indigo-500');
    });
    const selectedCard = document.querySelector(`#task-${task.product_id}-${task.stage_id}`);
    if (selectedCard) {
      selectedCard.classList.add('ring-2', 'ring-indigo-500');
    }
  }
}

// Update action buttons based on current task
function updateActionButtons() {
  console.log('updateActionButtons called, currentTask:', currentTask);
  const container = document.getElementById('actionButtonsContainer');
  if (!container) {
    console.error('Action buttons container not found!');
    return;
  }
  
  // If no task selected, show disabled state
  if (!currentTask) {
    container.innerHTML = `
      <button class="col-span-1 bg-gray-300 text-gray-500 font-bold py-3 px-2 text-center text-sm border-r border-b border-gray-200 transition-colors flex items-center justify-center gap-1 cursor-not-allowed" disabled>
        <span>‚ñ∂Ô∏è</span> Start
      </button>
      <button class="col-span-1 bg-gray-300 text-gray-500 font-bold py-3 px-2 text-center text-sm border-b border-gray-200 transition-colors flex items-center justify-center gap-1 cursor-not-allowed" disabled>
        <span>üë•</span> Assign
      </button>
      <button class="col-span-1 bg-gray-300 text-gray-500 font-bold py-3 px-2 text-center text-sm border-r border-gray-200 transition-colors flex items-center justify-center gap-1 cursor-not-allowed" disabled>
        <span>‚è∏Ô∏è</span> Pause
      </button>
      <button class="col-span-1 bg-gray-300 text-gray-500 font-bold py-3 px-2 text-center text-sm transition-colors flex items-center justify-center gap-1 cursor-not-allowed" disabled>
        <span>üõí</span> Material
      </button>
    `;
    return;
  }
  
  let buttons = '';
  
  if (currentTask.status === 'assigned') {
    console.log('Rendering buttons for ASSIGNED task');
    buttons = `
      <button id="startWorkBtn" class="col-span-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-2 text-center text-sm border-r border-b border-gray-200 transition-colors flex items-center justify-center gap-1">
        <span>‚ñ∂Ô∏è</span> Start
      </button>
      <button id="assignWorkersBtn" class="col-span-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-2 text-center text-sm border-b border-gray-200 transition-colors flex items-center justify-center gap-1">
        <span>üë•</span> Assign
      </button>
      <button id="pauseWorkBtn" class="col-span-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-2 text-center text-sm border-r border-gray-200 transition-colors flex items-center justify-center gap-1" style="display:none;">
        <span>‚è∏Ô∏è</span> Pause
      </button>
      <button id="materialRequestBtn" class="col-span-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-2 text-center text-sm transition-colors flex items-center justify-center gap-1">
        <span>üõí</span> Material
      </button>
    `;
  } else if (currentTask.status === 'working') {
    console.log('Rendering buttons for WORKING task');
    buttons = `
      <button id="completeWorkBtn" class="col-span-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-2 text-center text-sm border-r border-b border-gray-200 transition-colors flex items-center justify-center gap-1">
        <span>‚úÖ</span> Complete
      </button>
      <button id="assignWorkersBtn" class="col-span-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-2 text-center text-sm border-b border-gray-200 transition-colors flex items-center justify-center gap-1">
        <span>üë•</span> Assign
      </button>
      <button id="pauseWorkBtn" class="col-span-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-2 text-center text-sm border-r border-gray-200 transition-colors flex items-center justify-center gap-1">
        <span>‚è∏Ô∏è</span> Pause
      </button>
      <button id="materialRequestBtn" class="col-span-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-2 text-center text-sm transition-colors flex items-center justify-center gap-1">
        <span>üõí</span> Material
      </button>
    `;
  } else if (currentTask.status === 'completed') {
    console.log('Rendering view for COMPLETED task');
    buttons = `<div class="col-span-2 text-center py-4 text-gray-600 font-medium">‚úÖ Task Completed</div>`;
  } else {
    console.log('Unknown status:', currentTask.status);
    buttons = `<div class="col-span-2 text-center py-4 text-gray-600 font-medium">Status: ${currentTask.status}</div>`;
  }
  
  container.innerHTML = buttons;
  console.log('Buttons rendered:', buttons.substring(0, 100));
  
  // Attach event listeners
  document.getElementById('startWorkBtn')?.addEventListener('click', () => {
    console.log('Start Work clicked');
    startWork(currentTask.product_id, currentTask.stage_id);
  });
  document.getElementById('completeWorkBtn')?.addEventListener('click', () => {
    console.log('Complete Work clicked');
    completeWork(currentTask.product_id, currentTask.stage_id);
  });
  document.getElementById('pauseWorkBtn')?.addEventListener('click', () => {
    console.log('Pause Work clicked');
    pauseWork(currentTask.product_id, currentTask.stage_id);
  });
  document.getElementById('assignWorkersBtn')?.addEventListener('click', () => {
    console.log('Assign Workers clicked');
    assignWorkersModal(currentTask.product_id, currentTask.stage_id, currentTask.product_code, currentTask.stage_name);
  });
  document.getElementById('materialRequestBtn')?.addEventListener('click', () => {
    console.log('Material Request clicked');
    openMaterialRequestModal(currentTask.product_id, currentTask.product_code, currentTask.stage_name);
  });
}

// Create task card
function createTaskCard(task, isMobile = false) {
  const card = document.createElement('div');
  
  // Color coding based on status
  const statusColors = {
    'assigned': 'bg-gradient-to-br from-orange-50 to-orange-100 border-l-4 border-orange-500 shadow-md',
    'working': 'bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-500 shadow-md',
    'completed': 'bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-500 shadow-md'
  };
  
  const cardClasses = statusColors[task.status] || 'bg-white shadow-md';
  const padding = isMobile ? 'p-4' : 'p-6';
  
  card.className = `rounded-lg ${cardClasses} ${padding} ${isMobile ? 'mb-3 cursor-pointer task-card' : ''}`;
  card.id = `task-${task.product_id}-${task.stage_id}`;
  card.setAttribute('data-product-id', task.product_id);
  card.setAttribute('data-stage-id', task.stage_id);
  card.setAttribute('data-status', task.status);
  
  // Add click handler for mobile to select task
  if (isMobile) {
    card.addEventListener('click', () => selectTask(task));
  }
  
  const statusBadge = getStatusBadge(task.status);
  
  // Desktop actions only (skip for mobile, buttons in action bar)
  const actions = isMobile ? '' : getTaskActions(task);
  
  card.innerHTML = `
    <div class="flex flex-col space-y-3">
      <!-- Header Row -->
      <div class="flex items-start justify-between ${isMobile ? 'flex-wrap gap-2' : ''}">
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 ${isMobile ? 'flex-wrap' : ''}">
            <h3 class="text-lg font-bold text-gray-900">${task.product_code}</h3>
            <span class="${statusBadge.class}">
              ${statusBadge.text}
            </span>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
              ${task.stage_name}
            </span>
          </div>
          <p class="mt-1.5 text-sm text-gray-800 font-medium">${task.product_name}</p>
        </div>
        
        ${task.status === 'working' && !isMobile ? `
          <div style="width: 100px; height: 100px; margin-left: 16px; flex-shrink: 0;">
            <canvas id="chart-${task.product_id}-${task.stage_id}"></canvas>
          </div>
        ` : ''}
        
        <div class="hidden md:flex md:flex-col md:space-y-2">
          ${actions}
        </div>
      </div>
      
      <!-- Details Row -->
      <div class="grid ${isMobile ? 'grid-cols-2 gap-2' : 'grid-cols-3 gap-4'} text-xs">
        ${task.start_time ? `
          <div>
            <span class="text-gray-600 font-semibold">Started:</span>
            <div class="text-gray-900 font-medium">${new Date(task.start_time).toLocaleString('vi-VN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</div>
          </div>
        ` : ''}
        ${task.hours_worked && task.status === 'completed' ? `
          <div>
            <span class="text-gray-600 font-semibold">Hours:</span>
            <div class="text-gray-900 font-medium">${Math.round(task.hours_worked * 10) / 10}h</div>
          </div>
        ` : ''}
        ${task.end_time ? `
          <div>
            <span class="text-gray-600 font-semibold">Ended:</span>
            <div class="text-gray-900 font-medium">${new Date(task.end_time).toLocaleString('vi-VN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</div>
          </div>
        ` : ''}
      </div>
      
      ${task.notes ? `
        <div class="p-2.5 bg-white bg-opacity-60 rounded-md border-l-2 border-yellow-400">
          <p class="text-xs text-gray-800"><strong>üìù Notes:</strong> ${task.notes}</p>
        </div>
      ` : ''}
      
      <!-- Material Requests Section -->
      <div id="materialRequests-${task.product_id}-${task.stage_id}" class="mt-2.5 border-t border-opacity-30 pt-3 ${isMobile ? 'max-h-48 overflow-y-auto' : ''}">
        <div class="flex justify-between items-center mb-2">
          <h4 class="font-semibold text-gray-900 text-sm">üõí Y√™u C·∫ßu</h4>
          <button onclick="loadMaterialRequests(${task.product_id}, ${task.stage_id})" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium">
            <i class="fas fa-sync"></i>
          </button>
        </div>
        <div id="materialRequestsList-${task.product_id}-${task.stage_id}" class="space-y-2 text-sm">
          <p class="text-gray-500 italic">Loading...</p>
        </div>
      </div>
    </div>
  `;
  
  return card;
}

// Get status badge
function getStatusBadge(status) {
  const badges = {
    'assigned': { class: 'inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-orange-600 text-white shadow-sm', text: 'üìã Pending' },
    'working': { class: 'inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-600 text-white shadow-sm', text: '‚öôÔ∏è Working' },
    'completed': { class: 'inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-blue-600 text-white shadow-sm', text: '‚úÖ Done' }
  };
  return badges[status] || badges['assigned'];
}

// Get task actions
function getTaskActions(task) {
  if (task.status === 'assigned') {
    return `
      <button onclick="startWork(${task.product_id}, ${task.stage_id})" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm font-medium">Start Work</button>
      <button onclick="assignWorkersModal(${task.product_id}, ${task.stage_id}, '${task.product_code}', '${task.stage_name}')" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium">Assign Workers</button>
      <button onclick="openMaterialRequestModal(${task.product_id}, '${task.product_code}', '${task.stage_name}')" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 text-sm font-medium">Request Material</button>
    `;
  } else if (task.status === 'working') {
    return `
      <button onclick="completeWork(${task.product_id}, ${task.stage_id})" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium">Complete</button>
      <button onclick="pauseWork(${task.product_id}, ${task.stage_id})" class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 text-sm font-medium">Pause</button>
      <button onclick="assignWorkersModal(${task.product_id}, ${task.stage_id}, '${task.product_code}', '${task.stage_name}')" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium">Assign Workers</button>
      <button onclick="openMaterialRequestModal(${task.product_id}, '${task.product_code}', '${task.stage_name}')" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 text-sm font-medium">Request Material</button>
    `;
  } else {
    return `<span class="text-sm text-gray-500">Task completed</span>`;
  }
}

// Start work
async function startWork(productId, stageId) {
  try {
    const response = await fetch('/workflow/start-work', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify({ productId, stageId })
    });
    
    if (!response.ok) throw new Error('Failed to start work');
    
    alert('Work started successfully!');
    loadTasks(currentStatus);
    
  } catch (error) {
    console.error('Error starting work:', error);
    alert('Failed to start work');
  }
}

// Complete work
async function completeWork(productId, stageId) {
  const notes = prompt('Add notes (optional):');
  
  try {
    const response = await fetch('/workflow/complete-work', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify({ productId, stageId, notes })
    });
    
    if (!response.ok) throw new Error('Failed to complete work');
    
    alert('Work completed successfully!');
    loadTasks(currentStatus);
    
  } catch (error) {
    console.error('Error completing work:', error);
    alert('Failed to complete work');
  }
}

// Pause work
async function pauseWork(productId, stageId) {
  const reason = prompt('Reason for pausing:');
  if (!reason) return;
  
  try {
    const response = await fetch('/workflow/pause-work', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify({ productId, stageId, reason })
    });
    
    if (!response.ok) throw new Error('Failed to pause work');
    
    alert('Work paused successfully!');
    loadTasks(currentStatus);
    
  } catch (error) {
    console.error('Error pausing work:', error);
    alert('Failed to pause work');
  }
}

// Render hours chart
function renderHoursChart(task) {
  const chartId = `chart-${task.product_id}-${task.stage_id}`;
  const canvasElement = document.getElementById(chartId);
  
  if (!canvasElement) return;
  
  // Calculate hours
  const yourHours = Math.round(task.hours_elapsed * 10) / 10;
  const stageTotal = Math.round(task.stage_total_hours * 10) / 10;
  const otherHours = Math.max(0, stageTotal - yourHours);
  const remainingHours = Math.max(0, task.norm_hours - stageTotal);
  
  // Destroy existing chart if any
  if (window.charts && window.charts[chartId]) {
    window.charts[chartId].destroy();
  }
  
  if (!window.charts) {
    window.charts = {};
  }
  
  const ctx = canvasElement.getContext('2d');
  const chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: [
        `${yourHours}h`,
        `${otherHours}h`,
        `${remainingHours}h`
      ],
      datasets: [{
        data: [yourHours, otherHours, remainingHours],
        backgroundColor: [
          '#3b82f6', // Blue for your hours
          '#60a5fa', // Light blue for others
          '#d1d5db'  // Gray for remaining
        ],
        borderColor: [
          '#ffffff',
          '#ffffff',
          '#ffffff'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.label + ': ' + context.parsed + 'h';
            }
          }
        }
      }
    }
  });
  
  window.charts[chartId] = chart;
}

// Material Request Modal Functions
function openMaterialRequestModal(productId, productCode, stageName) {
  const modal = document.getElementById('materialRequestModal');
  document.getElementById('modalProductCode').textContent = productCode;
  document.getElementById('modalStageName').textContent = stageName;
  document.getElementById('requestProductId').value = productId;
  document.getElementById('requestStage').value = stageName;
  modal.classList.remove('hidden');
}

// Load and display material requests for a stage
async function loadMaterialRequests(productId, stageId) {
  try {
    const response = await fetch(`/workflow/product/${productId}/stage/${stageId}/material-requests`, {
      headers: { 'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}` }
    });

    if (!response.ok) throw new Error('Failed to load material requests');
    const data = await response.json();
    const requests = data.data || [];

    const container = document.getElementById(`materialRequestsList-${productId}-${stageId}`);
    if (!container) return;

    if (requests.length === 0) {
      container.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ y√™u c·∫ßu mua h√†ng</p>';
      return;
    }

    container.innerHTML = requests.map(req => {
      const statusColors = {
        'pending': 'bg-yellow-100 text-yellow-800',
        'purchased': 'bg-green-100 text-green-800',
        'delivered': 'bg-blue-100 text-blue-800'
      };
      const statusText = {
        'pending': 'Ch·ªù',
        'purchased': 'ƒê√£ Mua',
        'delivered': 'ƒê√£ Nh·∫≠n'
      };

      return `
        <div class="p-3 border rounded-lg bg-orange-50 cursor-pointer" onclick="event.stopPropagation(); expandMaterialRequest(this, ${req.id})">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <p class="font-semibold text-gray-900 text-sm">${req.reason || 'Y√™u c·∫ßu'}</p>
              <p class="text-xs text-gray-600 mt-1">Y√™u c·∫ßu b·ªüi: ${req.requested_by_name}</p>
            </div>
            <span class="px-2 py-1 text-xs font-semibold rounded ${statusColors[req.status] || statusColors.pending}">
              ${statusText[req.status] || req.status}
            </span>
          </div>
          <div id="materialRequestDetail-${req.id}" class="hidden mt-3 space-y-2 border-t pt-2" style="display:none;">
            <p class="text-xs text-gray-600"><strong>Tr·∫°ng th√°i:</strong> ${req.status}</p>
            ${req.purchased_by_name ? `<p class="text-xs text-gray-600"><strong>X·ª≠ l√Ω b·ªüi:</strong> ${req.purchased_by_name}</p>` : ''}
            ${req.expected_delivery_date ? `<p class="text-xs text-gray-600"><strong>D·ª± ki·∫øn giao:</strong> ${new Date(req.expected_delivery_date).toLocaleDateString('vi-VN')}</p>` : ''}
            <div class="bg-gray-50 p-2 rounded border border-gray-200">
              <div id="comments-${req.id}" class="text-xs space-y-2 max-h-40 overflow-y-auto mb-2">
                <p class="text-gray-400 italic text-center py-2">ƒêang t·∫£i b√¨nh lu·∫≠n...</p>
              </div>
              <textarea id="commentInput-${req.id}" class="w-full p-2 text-xs border rounded" placeholder="Th√™m b√¨nh lu·∫≠n..." onclick="event.stopPropagation()"></textarea>
              <button onclick="event.stopPropagation(); addMaterialRequestComment(${req.id})" class="w-full mt-1 px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">
                G·ª≠i B√¨nh Lu·∫≠n
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');

  } catch (error) {
    console.error('Error loading material requests:', error);
    const container = document.getElementById(`materialRequestsList-${productId}-${stageId}`);
    if (container) {
      container.innerHTML = `<p class="text-red-500 text-xs">L·ªói: ${error.message}</p>`;
    }
  }
}

// Expand/collapse material request details and load comments
async function expandMaterialRequest(element, requestId) {
  const detail = document.getElementById(`materialRequestDetail-${requestId}`);
  if (detail) {
    if (detail.style.display === 'none') {
      detail.style.display = 'block';
      // Load comments when expanding
      await loadMaterialRequestComments(requestId);
    } else {
      detail.style.display = 'none';
    }
  }
}

// Load and display comments for a material request
async function loadMaterialRequestComments(requestId) {
  try {
    const response = await fetch(`/workflow/material-request/${requestId}/messages`, {
      headers: { 'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}` }
    });

    if (!response.ok) throw new Error('Failed to load comments');
    const data = await response.json();
    const comments = data.data || [];

    const commentsDiv = document.getElementById(`comments-${requestId}`);
    if (!commentsDiv) return;

    if (comments.length === 0) {
      commentsDiv.innerHTML = '<p class="text-gray-500 italic">Ch∆∞a c√≥ b√¨nh lu·∫≠n</p>';
      return;
    }

    commentsDiv.innerHTML = comments.map(comment => {
      const date = new Date(comment.created_at);
      const timeStr = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
      const roleLabel = comment.role === 'THU_MUA' ? 'üë®‚Äçüíº Thu Mua' : comment.role === 'WORKER' ? 'üîß C√¥ng Nh√¢n' : 'üë§ ' + comment.role;
      return `
        <div class="border-l-2 border-blue-400 pl-2 py-1">
          <div class="text-xs font-semibold text-blue-600">${roleLabel} - ${comment.full_name}</div>
          <div class="text-xs text-gray-700 mt-0.5">${comment.message}</div>
          <div class="text-xs text-gray-400">${timeStr}</div>
        </div>
      `;
    }).join('');

  } catch (error) {
    console.error('Error loading comments:', error);
    const commentsDiv = document.getElementById(`comments-${requestId}`);
    if (commentsDiv) {
      commentsDiv.innerHTML = `<p class="text-red-500 text-xs">L·ªói: ${error.message}</p>`;
    }
  }
}

// Add comment to material request
async function addMaterialRequestComment(requestId) {
  const commentInput = document.getElementById(`commentInput-${requestId}`);
  const comment = commentInput.value.trim();

  if (!comment) {
    alert('Vui l√≤ng nh·∫≠p b√¨nh lu·∫≠n');
    return;
  }

  try {
    const response = await fetch(`/workflow/material-request/${requestId}/update`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify({ comment })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    commentInput.value = '';
    alert('B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c th√™m!');
    
    // Reload comments immediately
    await loadMaterialRequestComments(requestId);

  } catch (error) {
    console.error('Error adding comment:', error);
    alert('L·ªói: ' + error.message);
  }
}

function closeMaterialRequestModal() {
  const modal = document.getElementById('materialRequestModal');
  modal.classList.add('hidden');
  document.getElementById('materialRequestForm').reset();
}

async function submitMaterialRequest(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const data = {
    productId: parseInt(formData.get('productId')),
    stage: formData.get('stage'),
    materials: formData.get('materials'),
    quantity: parseInt(formData.get('quantity')),
    urgency: formData.get('urgency'),
    notes: formData.get('notes')
  };
  
  try {
    const response = await fetch('/purchasing/request/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify(data)
    });
    
    if (!response.ok) throw new Error('Failed to create material request');
    
    alert('Material request submitted successfully!');
    closeMaterialRequestModal();
    
  } catch (error) {
    console.error('Error submitting material request:', error);
    alert('Failed to submit material request');
  }
}

// Assign workers modal
let currentAssignProductId = null;
let currentAssignStageId = null;
let currentAssignProductCode = '';
let currentAssignStageName = '';
let availableAssignWorkers = [];

async function assignWorkersModal(productId, stageId, productCode, stageName) {
  currentAssignProductId = productId;
  currentAssignStageId = stageId;
  currentAssignProductCode = productCode;
  currentAssignStageName = stageName;
  
  try {
    // Fetch assigned workers for this stage
    const assignedResponse = await fetch(`/workflow/assigned-workers/${productId}/${stageId}`, {
      headers: {
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      }
    });
    
    if (!assignedResponse.ok) throw new Error('Failed to fetch assigned workers');
    const assignedData = await assignedResponse.json();
    const assignedWorkerIds = (assignedData.data || []).map(w => w.user_id);
    
    // Fetch available workers for this stage (role-based filtering)
    const workersResponse = await fetch(`/workflow/available-workers/${productId}/${stageId}`, {
      headers: {
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      }
    });
    
    if (!workersResponse.ok) throw new Error('Failed to fetch available workers');
    const workersData = await workersResponse.json();
    availableAssignWorkers = workersData.data || [];
    
    // Update modal content
    document.getElementById('assignWorkerProductCode').textContent = productCode;
    document.getElementById('assignWorkerStageName').textContent = stageName;
    
    // Populate workers checkboxes
    const workersContainer = document.getElementById('assignWorkersList');
    workersContainer.innerHTML = '';
    if (availableAssignWorkers.length === 0) {
      workersContainer.innerHTML = '<p class="text-gray-500 text-sm">No available workers from this stage</p>';
    } else {
      availableAssignWorkers.forEach(user => {
        const isAssigned = assignedWorkerIds.includes(user.id);
        const label = document.createElement('label');
        label.className = `flex items-center p-2 rounded ${isAssigned ? 'bg-green-50 border border-green-200' : 'hover:bg-gray-50'}`;
        label.innerHTML = `
          <input type="checkbox" name="assignWorker" value="${user.id}" ${isAssigned ? 'checked disabled' : ''} class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${isAssigned ? 'style="cursor:not-allowed"' : ''}>
          <span class="ml-2 text-sm">${user.full_name} (${user.username}) - <span class="text-xs text-gray-500">${user.role}</span>${isAssigned ? ' <span class="ml-2 inline-block px-2 py-0.5 text-xs bg-green-200 text-green-800 rounded-full font-medium">Already assigned</span>' : ''}</span>
        `;
        workersContainer.appendChild(label);
      });
    }
    
    // Show modal
    document.getElementById('assignWorkersWorkerModal').classList.remove('hidden');
    
  } catch (error) {
    console.error('Error opening assign workers modal:', error);
    alert('Failed to load available workers: ' + error.message);
  }
}

function closeAssignWorkersWorkerModal() {
  document.getElementById('assignWorkersWorkerModal').classList.add('hidden');
  document.getElementById('assignWorkersWorkerForm').reset();
}

async function submitAssignWorkers(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const selectedWorkers = formData.getAll('assignWorker').map(id => parseInt(id));
  
  if (selectedWorkers.length === 0) {
    alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 worker');
    return;
  }
  
  try {
    const response = await fetch('/workflow/assign-workers', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken || localStorage.getItem('token') || ''}`
      },
      body: JSON.stringify({
        productId: currentAssignProductId,
        stageId: currentAssignStageId,
        userIds: selectedWorkers
      })
    });
    
    if (!response.ok) throw new Error('Failed to assign workers');
    
    alert('Workers assigned successfully!');
    closeAssignWorkersWorkerModal();
    loadTasks(currentStatus); // Refresh data
    
  } catch (error) {
    console.error('Error assigning workers:', error);
    alert('Failed to assign workers: ' + error.message);
  }
}

// Calculate header height and set layout position dynamically
function adjustLayoutForHeader() {
  if (window.innerWidth >= 768) return; // Only for mobile
  
  const headerNav = document.querySelector('nav.bg-gradient-to-r');
  const mobileLayout = document.querySelector('.md\\:hidden.flex.flex-col');
  
  if (!headerNav || !mobileLayout) {
    console.warn('Header nav or mobile layout not found');
    return;
  }
  
  const headerHeight = headerNav.offsetHeight;
  
  // Set body padding
  document.body.style.paddingTop = headerHeight + 'px';
  
  // Set mobile layout padding top
  mobileLayout.style.paddingTop = headerHeight + 'px';
  
  console.log('Header height calculated:', headerHeight);
}

// Load tasks on page load
document.addEventListener('DOMContentLoaded', () => {
  // Give a small delay for header to fully render
  setTimeout(() => {
    adjustLayoutForHeader();
  }, 100);
  
  updateTaskCounts();
  loadTasks('assigned');
  // Initialize action buttons in disabled state
  updateActionButtons();
});

// Re-adjust on window resize
window.addEventListener('resize', adjustLayoutForHeader);
</script>

<!-- Assign Workers Modal -->
<div id="assignWorkersWorkerModal" class="hidden fixed z-50 inset-0 overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeAssignWorkersWorkerModal()"></div>
    
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <form id="assignWorkersWorkerForm" onsubmit="submitAssignWorkers(event)">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
              <i class="fas fa-users text-blue-600"></i>
            </div>
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
              <h3 class="text-lg leading-6 font-medium text-gray-900">Assign Workers</h3>
              <p class="text-sm text-gray-500 mt-1">
                Product: <span id="assignWorkerProductCode" class="font-semibold"></span> - 
                Stage: <span id="assignWorkerStageName" class="font-semibold"></span>
              </p>
              
              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Workers *</label>
                <div id="assignWorkersList" class="max-h-64 overflow-y-auto border rounded-md p-2 space-y-1">
                  <!-- Workers will be populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button 
            type="submit"
            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
            Assign Workers
          </button>
          <button 
            type="button"
            onclick="closeAssignWorkersWorkerModal()"
            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Material Request Modal -->
<div id="materialRequestModal" class="hidden fixed z-50 inset-0 overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeMaterialRequestModal()"></div>
    
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <form id="materialRequestForm" onsubmit="submitMaterialRequest(event)">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-purple-100 sm:mx-0 sm:h-10 sm:w-10">
              <i class="fas fa-box text-purple-600"></i>
            </div>
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
              <h3 class="text-lg leading-6 font-medium text-gray-900">Request Material</h3>
              <p class="text-sm text-gray-500 mt-1">
                Product: <span id="modalProductCode" class="font-semibold"></span> - 
                Stage: <span id="modalStageName" class="font-semibold"></span>
              </p>
              
              <input type="hidden" name="productId" id="requestProductId">
              <input type="hidden" name="stage" id="requestStage">
              
              <div class="mt-4 space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">Materials Needed *</label>
                  <textarea 
                    name="materials" 
                    required
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"
                    placeholder="Describe the materials needed..."></textarea>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700">Quantity *</label>
                  <input 
                    type="number" 
                    name="quantity" 
                    required
                    min="1"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"
                    placeholder="Enter quantity">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700">Urgency *</label>
                  <select 
                    name="urgency" 
                    required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm">
                    <option value="low">Low - Can wait</option>
                    <option value="medium" selected>Medium - Needed soon</option>
                    <option value="high">High - Urgent</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700">Notes</label>
                  <textarea 
                    name="notes" 
                    rows="2"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm"
                    placeholder="Additional notes (optional)"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button 
            type="submit"
            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-purple-600 text-base font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:ml-3 sm:w-auto sm:text-sm">
            Submit Request
          </button>
          <button 
            type="button"
            onclick="closeMaterialRequestModal()"
            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<%- include('../footer') %>
